<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Binary Profit Table (Frontend)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer"/>
  <link rel="preconnect" href="https://rsms.me/">
  <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
  <style>
    :root {
      --sidebar-bg:     #000000;
      --main-bg:        #000000;
      --header-bg:      #000000;
      --text-primary:   #ffffff;
      --text-secondary: #cccccc;
      --accent-positive:#00d0b2;
      --accent-negative:#f44336;
      --badge-bg:       #5b8a92;
      --badge-text:     #ffffff;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: Inter, sans-serif;
      font-feature-settings: 'tnum';
      background: var(--main-bg);
      color: var(--text-primary);
      font-size: 14px;
    }
    .container { display: flex; height: 100vh; flex-direction: column; }
    main.main { flex: 1; padding: 20px; display: flex; flex-direction: column; }
    .table-container {
      flex: 1; overflow-y: auto; overflow-x: hidden; scrollbar-width: none;
      background-color: #000; max-height: calc(100vh - 50px);
    }
    .table-container::-webkit-scrollbar { display: none; }
    table { width: 100%; border-collapse: collapse; min-width: 900px; }
    thead th {
      position: sticky; top: 0; background: var(--header-bg);
      padding: 12px; color: var(--text-primary); text-align: left;
      font-size: 13px; font-weight: 500;
    }
    tbody td { padding: 12px; color: var(--text-secondary); font-size: 13px; }
    tbody tr:hover td { background: #111; }

    /* --- Type logo cell --- */
    .type-wrap { display:flex; align-items:center; gap:10px; }
    .type-logo {
      width: 1.5cm;    /* requested physical size */
      height: 1cm;
      max-width: 120px;  /* sensible fallback for some browsers */
      max-height: 80px;
      display: block;
      object-fit: contain;
      image-rendering: -webkit-optimize-contrast;
      image-rendering: crisp-edges;
    }

    .badge.currency {
      background: var(--badge-bg); color: var(--badge-text);
      padding: 2px 6px; border-radius: 4px; font-size: 11px;
    }
    .time { display:block; color: var(--text-secondary); font-size: 14px; margin-top: 2px; }
    td.positive { color: var(--accent-positive); font-weight: 600; }
    td.negative { color: var(--accent-negative); font-weight: 600; }
    tbody td:nth-child(2),
    tbody td:nth-child(4),
    tbody td:nth-child(5),
    tbody td:nth-child(6),
    tbody td:nth-child(7) {
      color:#eee; font-size:14px; font-weight:500; opacity:.7;
    }
    td:nth-child(8) { font-size:14px; }

    .summary {
      position: sticky; bottom: 0; background: var(--main-bg); z-index: 1;
      margin-top: 10px; display: flex; font-size: 13px; font-weight: 600;
      color: var(--text-secondary); padding: 10px 0 0; border-top: 1px solid #222;
    }
    .summary span:first-child { flex: 7; }
    .summary .total-profit {
      flex: 1; color: var(--accent-positive); font-size: 14px; text-align: left; margin-left: -7cm;
    }
  </style>
</head>
<body>
  <div class="container">
    <main class="main">
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Type</th>
              <th>Ref. ID</th>
              <th>Currency</th>
              <th>Buy time</th>
              <th>Stake</th>
              <th>Sell time</th>
              <th>Contract value</th>
              <th>Total profit/loss</th>
            </tr>
          </thead>
          <tbody id="trade-body"></tbody>
        </table>
      </div>
      <div class="summary">
        <span>Profit/loss on the last 150 contracts</span>
        <span class="total-profit" id="total-profit">3,659.96</span>
      </div>
    </main>
  </div>

  <script>
    // ==== CONFIGURABLE: PNG logo links for the "Type" column ====
    // Add/remove your own PNG links here. You can also set window.TYPE_LOGOS = [...] from console.
    window.TYPE_LOGOS = [
      "https://iili.io/KxDwyen.png",
      "https://iili.io/KxDOC4p.png"
    ];
    // =============================================================

    const tbody            = document.getElementById('trade-body');
    const totalProfitEl    = document.getElementById('total-profit');
    const STORAGE_TRADES   = 'persistedTrades';
    const STORAGE_PROFIT   = 'persistedTotalProfit';

    let trades      = JSON.parse(localStorage.getItem(STORAGE_TRADES)) || [];
    let totalProfit = parseFloat(localStorage.getItem(STORAGE_PROFIT));
    if (isNaN(totalProfit)) totalProfit = 3659.96;

    // UTC/GMT formatters
    const fmtDate = d => new Intl.DateTimeFormat('en-GB', {
      day: '2-digit', month: 'short', year: 'numeric', timeZone: 'UTC'
    }).format(d);

    const fmtTime = d => new Intl.DateTimeFormat('en-GB', {
      hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit', timeZone: 'UTC'
    }).format(d);

    // Ref ID: must start with '14' and be exactly 12 digits total => '14' + 10 random digits
    function formatRefId() {
      let rest = '';
      for (let i = 0; i < 10; i++) rest += Math.floor(Math.random() * 10);
      return '14' + rest;
    }

    function pickLogo(customUrl) {
      if (customUrl) return customUrl;
      const list = Array.isArray(window.TYPE_LOGOS) && window.TYPE_LOGOS.length ? window.TYPE_LOGOS : [];
      if (!list.length) return '';
      return list[Math.floor(Math.random() * list.length)];
    }

    function rowHTML(data) {
      // ensure UTC times exist (live default to "now" if not provided)
      const buyDate  = data.buyTime ? new Date(data.buyTime)  : new Date();
      const sellDate = data.sellTime ? new Date(data.sellTime) : new Date();

      const cls  = data.profit >= 0 ? 'positive' : 'negative';
      const sign = data.profit >= 0 ? '+' : '';
      const refId = formatRefId();
      const cv = (data.stake + data.profit).toFixed(2);
      const logo = pickLogo(data.logo);

      return `
        <tr>
          <td>
            <div class="type-wrap">
              <img class="type-logo" src="${logo}" alt="type-logo" />
            </div>
          </td>
          <td>${refId}</td>
          <td><span class="badge currency">USD</span></td>
          <td>${fmtDate(buyDate)}<br><span class="time">${fmtTime(buyDate)} GMT</span></td>
          <td>${Number(data.stake||0).toFixed(2)}</td>
          <td>${fmtDate(sellDate)}<br><span class="time">${fmtTime(sellDate)} GMT</span></td>
          <td>${cv}</td>
          <td class="${cls}">${sign}${Number(data.profit||0).toFixed(2)}</td>
        </tr>`;
    }

    function renderSavedTrades() {
      trades.slice().reverse().forEach(data => {
        tbody.insertAdjacentHTML('afterbegin', rowHTML(data));
      });
    }

    function updateTotalProfitDisplay() {
      totalProfitEl.textContent =
        (totalProfit >= 0 ? '+' : '') +
        totalProfit.toLocaleString('en-GB', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function addTrade(data) {
      // fallback defaults if some fields missing when live-updating
      data = {
        stake:  Number(data?.stake ?? 0),
        profit: Number(data?.profit ?? 0),
        buyTime: data?.buyTime || new Date().toISOString(),
        sellTime: data?.sellTime || new Date().toISOString(),
        logo: data?.logo || undefined
      };

      tbody.insertAdjacentHTML('afterbegin', rowHTML(data));

      totalProfit += data.profit;
      localStorage.setItem(STORAGE_PROFIT, totalProfit);
      updateTotalProfitDisplay();

      trades.unshift(data);
      localStorage.setItem(STORAGE_TRADES, JSON.stringify(trades));
    }

    renderSavedTrades();
    updateTotalProfitDisplay();

    // Live updates channel (send {stake, profit, buyTime?, sellTime?, logo?})
    const profitChannel = new BroadcastChannel('trade-profits');
    profitChannel.onmessage = ({ data }) => addTrade(data);

    // Demo (remove in production): uncomment to test a random row every 4s
    /*
    setInterval(() => {
      const p = (Math.random() > 0.5 ? 1 : -1) * (5 + Math.random() * 50);
      addTrade({ stake: 100, profit: p });
    }, 4000);
    */
  </script>
</body>
</html>
